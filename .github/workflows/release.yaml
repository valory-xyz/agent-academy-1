name: Release Flow

on:
    push:
# 
# on:
#   publish:
#     types: [published]
# 
jobs:
  publish-packages:
    name: Push Packages
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@master
      - uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-versions }}
      - uses: addnab/docker-run-action@v3
        with:
            image: valory/open-autonomy-user:latest
            options: -v ${{ github.workspace }}:/work
            run: |
              echo "Pushing Packages"
              cd /work
              export AUTHOR=$(grep 'service' packages/packages.json | awk -F/ '{print $2}' | head -1)
              autonomy init --reset --author $AUTHOR --ipfs --remote
              autonomy push-all
  publish-images:
    name: Publish Docker Images
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10"]
    steps:
      - uses: actions/checkout@v2
      - name: Set up tag and vars
        uses: addnab/docker-run-action@v3
        with:
            image: valory/open-autonomy-user:latest
            options: -v ${{ github.workspace }}:/work
            run: |
              echo "Setting Tag Images"
              cd /work
              echo "VERSION=0.8.0" > env.sh
              echo AUTHOR=$(grep 'service' packages/packages.json | awk -F/ '{print $2}' | head -1) >> env.sh
              echo SERVICE=$(grep 'service' packages/packages.json | awk -F/ '{print $3}' | head -1) >> env.sh
              cat env.sh

      - uses: addnab/docker-run-action@v3
        name: Build Images
        with:
            image: valory/open-autonomy-user:latest
            options: -v ${{ github.workspace }}:/work
            entrypoint: "/bin/bash"
            shell: bash
            run: |
                echo "Building Docker Images"
                source env.sh
                echo "Building images for $AUTHOR for service $SERVICE"
                autonomy fetch $AUTHOR/$SERVICE --service --local
                # cd $SERVICE
                # autonomy build-image --version $VERSION 
                # autonomy build-image 


        #       - uses: addnab/docker-run-action@v3
        #         with:
        #             image: valory/open-autonomy-user:latest
        #             options: -v ${{ github.workspace }}:/work
        #             run: |
        #               echo "Building Service"
        #               cd /work
        #   
        #           docker build -t valory/open-autonomy-docs:$TAG -f deployments/Dockerfiles/documentation/Dockerfile .
        #       - name: Tag to latest
        #         run:  |
        #           source env.sh
        #           docker tag valory/open-autonomy-docs:$TAG valory/open-autonomy-docs:latest
        #       - name: Docker login
        #         env:
        #           DOCKER_USER: ${{secrets.DOCKER_USER}}
        #           DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
        #         run: |
        #           docker login -u $DOCKER_USER -p $DOCKER_PASSWORD 
        #       - name: Docker Push
        #         run: |
        #           source env.sh
        #           docker push valory/open-autonomy-docs:$TAG 
        #           docker push valory/open-autonomy-docs:latest
        #   
